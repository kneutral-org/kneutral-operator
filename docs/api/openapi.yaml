openapi: 3.0.3
info:
  title: Kneutral Operator API
  description: |
    The Kneutral Operator API provides REST endpoints for managing AlertRule resources in Kubernetes.

    The operator automatically converts AlertRule custom resources into PrometheusRule resources
    that can be consumed by Prometheus Operator for alerting.

    ## Features
    - CRUD operations on AlertRule resources
    - Automatic PrometheusRule generation
    - Namespace-scoped operations
    - Health and status monitoring

    ## Authentication
    Currently, the API does not require authentication. This may change in future versions.
  version: v1alpha1
  contact:
    name: Kneutral Team
    email: support@kneutral.io
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://kneutral-operator-api.kneutral-system:8090
    description: Kubernetes cluster internal endpoint
  - url: http://localhost:8090
    description: Local development server

tags:
  - name: Health
    description: Health and status endpoints
  - name: AlertRules
    description: AlertRule management operations
  - name: Documentation
    description: API documentation and schema

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check if the API server is healthy and responsive
      responses:
        '200':
          description: API server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
              examples:
                healthy:
                  summary: Healthy response
                  value:
                    status: healthy

  /api/v1/alertrules:
    get:
      tags:
        - AlertRules
      summary: List all AlertRules
      description: Retrieve a list of all AlertRule resources across all namespaces
      responses:
        '200':
          description: List of AlertRules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertRuleList'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/namespaces/{namespace}/alertrules:
    parameters:
      - $ref: '#/components/parameters/namespace'

    get:
      tags:
        - AlertRules
      summary: List AlertRules in namespace
      description: Retrieve all AlertRule resources in a specific namespace
      responses:
        '200':
          description: List of AlertRules in the namespace
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertRuleList'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags:
        - AlertRules
      summary: Create AlertRule
      description: Create a new AlertRule resource in the specified namespace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlertRule'
            examples:
              basic-alert:
                summary: Basic alert example
                value:
                  metadata:
                    name: example-alert
                  spec:
                    groups:
                      - name: example.rules
                        rules:
                          - alert: HighMemoryUsage
                            expr: 'memory_usage_percent > 80'
                            for: 5m
                            labels:
                              severity: warning
                            annotations:
                              summary: High memory usage detected
              network-alert:
                summary: Network monitoring alert
                value:
                  metadata:
                    name: network-alerts
                  spec:
                    groups:
                      - name: network.rules
                        interval: 30s
                        rules:
                          - alert: HighBandwidthUsage
                            expr: 'rate(network_bytes_total[5m]) > 1000000'
                            for: 2m
                            labels:
                              severity: critical
                              team: network
                            annotations:
                              summary: High bandwidth usage on {{ $labels.interface }}
                              description: Bandwidth usage is {{ $value }} bytes/sec
      responses:
        '201':
          description: AlertRule created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertRule'
        '400':
          description: Invalid request body or missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: AlertRule with the same name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/namespaces/{namespace}/alertrules/{name}:
    parameters:
      - $ref: '#/components/parameters/namespace'
      - $ref: '#/components/parameters/name'

    get:
      tags:
        - AlertRules
      summary: Get AlertRule
      description: Retrieve a specific AlertRule resource by name and namespace
      responses:
        '200':
          description: AlertRule details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertRule'
        '404':
          description: AlertRule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - AlertRules
      summary: Update AlertRule
      description: Update an existing AlertRule resource
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlertRuleSpec'
            examples:
              update-spec:
                summary: Update AlertRule spec
                value:
                  groups:
                    - name: updated.rules
                      interval: 60s
                      rules:
                        - alert: UpdatedAlert
                          expr: 'cpu_usage > 90'
                          for: 10m
                          labels:
                            severity: critical
                          annotations:
                            summary: CPU usage is very high
      responses:
        '200':
          description: AlertRule updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertRule'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: AlertRule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - AlertRules
      summary: Delete AlertRule
      description: Delete an AlertRule resource
      responses:
        '204':
          description: AlertRule deleted successfully
        '404':
          description: AlertRule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /openapi/v2:
    get:
      tags:
        - Documentation
      summary: Get OpenAPI specification
      description: Retrieve the OpenAPI 2.0 specification for this API
      responses:
        '200':
          description: OpenAPI specification
          content:
            application/json:
              schema:
                type: object

components:
  parameters:
    namespace:
      name: namespace
      in: path
      required: true
      description: Kubernetes namespace name
      schema:
        type: string
        pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
        example: monitoring

    name:
      name: name
      in: path
      required: true
      description: AlertRule resource name
      schema:
        type: string
        pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
        example: example-alerts

  schemas:
    AlertRule:
      type: object
      required:
        - metadata
        - spec
      properties:
        apiVersion:
          type: string
          enum:
            - monitoring.kneutral.io/v1alpha1
          example: monitoring.kneutral.io/v1alpha1
        kind:
          type: string
          enum:
            - AlertRule
          example: AlertRule
        metadata:
          $ref: '#/components/schemas/ObjectMeta'
        spec:
          $ref: '#/components/schemas/AlertRuleSpec'
        status:
          $ref: '#/components/schemas/AlertRuleStatus'

    AlertRuleList:
      type: object
      required:
        - items
      properties:
        apiVersion:
          type: string
          enum:
            - monitoring.kneutral.io/v1alpha1
          example: monitoring.kneutral.io/v1alpha1
        kind:
          type: string
          enum:
            - AlertRuleList
          example: AlertRuleList
        metadata:
          $ref: '#/components/schemas/ListMeta'
        items:
          type: array
          items:
            $ref: '#/components/schemas/AlertRule'

    ObjectMeta:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Name of the AlertRule resource
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          example: example-alerts
        namespace:
          type: string
          description: Namespace of the AlertRule resource
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          example: monitoring
        labels:
          type: object
          additionalProperties:
            type: string
          description: Labels for the AlertRule resource
          example:
            app: monitoring
            environment: production
        annotations:
          type: object
          additionalProperties:
            type: string
          description: Annotations for the AlertRule resource
        creationTimestamp:
          type: string
          format: date-time
          description: Creation timestamp
        uid:
          type: string
          description: Unique identifier
        generation:
          type: integer
          description: Generation number

    ListMeta:
      type: object
      properties:
        continue:
          type: string
        remainingItemCount:
          type: integer

    AlertRuleSpec:
      type: object
      required:
        - groups
      properties:
        groups:
          type: array
          description: List of alert groups
          minItems: 1
          items:
            $ref: '#/components/schemas/AlertGroup'
        labels:
          type: object
          additionalProperties:
            type: string
          description: Labels to add to the generated PrometheusRule
          example:
            app.kubernetes.io/instance: kneutral

    AlertGroup:
      type: object
      required:
        - name
        - rules
      properties:
        name:
          type: string
          description: Name of the alert group
          example: example.rules
        interval:
          type: string
          description: How often rules in the group are evaluated (e.g., "30s", "1m")
          pattern: '^[0-9]+[smh]$'
          example: 30s
        rules:
          type: array
          description: List of alert rules in this group
          minItems: 1
          items:
            $ref: '#/components/schemas/Rule'

    Rule:
      type: object
      required:
        - alert
        - expr
      properties:
        alert:
          type: string
          description: Name of the alert
          example: HighCPUUsage
        expr:
          type: string
          description: PromQL expression to evaluate
          example: 'cpu_usage_percent > 80'
        for:
          type: string
          description: How long the condition must be true before firing
          pattern: '^[0-9]+[smh]$'
          example: 5m
        labels:
          type: object
          additionalProperties:
            type: string
          description: Labels to add or override on the alert
          example:
            severity: warning
            team: infrastructure
        annotations:
          type: object
          additionalProperties:
            type: string
          description: Annotations to add to the alert
          example:
            summary: High CPU usage detected
            description: CPU usage is {{ $value }}% on {{ $labels.instance }}

    AlertRuleStatus:
      type: object
      properties:
        conditions:
          type: array
          description: Current conditions of the AlertRule
          items:
            $ref: '#/components/schemas/Condition'
        lastReconcileTime:
          type: string
          format: date-time
          description: Last time the AlertRule was reconciled
        prometheusRuleName:
          type: string
          description: Name of the generated PrometheusRule resource
          example: kneutral-example-alerts
        state:
          type: string
          description: Current state of the AlertRule
          enum:
            - Active
            - Error
            - Pending
          example: Active

    Condition:
      type: object
      required:
        - type
        - status
      properties:
        type:
          type: string
          description: Type of condition
          example: Ready
        status:
          type: string
          enum:
            - "True"
            - "False"
            - Unknown
          description: Status of the condition
          example: "True"
        observedGeneration:
          type: integer
          format: int64
          description: Generation observed
        lastTransitionTime:
          type: string
          format: date-time
          description: Last time the condition transitioned
        reason:
          type: string
          description: Reason for the condition
          example: ReconcileSuccess
        message:
          type: string
          description: Human-readable message
          example: PrometheusRule kneutral-example-alerts created/updated successfully

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: AlertRule not found
        details:
          type: string
          description: Additional error details